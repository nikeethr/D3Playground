<!DOCTYPE html>
<meta charset = "utf-8">

<style>
    .background {
        fill: #eee;
    }

    .map-layer {
        fill: #fff;
        stroke: #333;
    }
    .side-by-side {
        float: left;
        padding: 0px 20px;
    }
</style>

<body>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>

<script>
    var width = 300;
    var height = 300;
    var numMaps = 2;

    var colors = d3.scale.category20();

    var mapColorStatic = "#fee6ce";
    var colorCircles = d3.scale.linear()
        .domain([1, 100]) // todo: scale by value
        .range(["#deebf7", "#3182bd"]);

    var projection = d3.geo.mercator()
        .scale(300)
        .center([133.8, -25.3])
        .translate([width/2, height/2])

    path = d3.geo.path().projection(projection)

    function renderMaps(geo, data) {
        var visWrapper = d3.select('body');
        for (i = 0; i < data.length; i++) {
            var wrapper = visWrapper
                .append('div')
                .style({
                    width: width + 'px',
                    height: height + 'px',
                    float: "left"
                });

            createMap(wrapper, geo, data[i]);
        }
    }

    function createMap(wrapper, geo, data) {
        var svg = wrapper.append('svg')
            .attr({
                width: width,
                height: height
            });

        var mapLayer = svg.append('g')
            .classed('map-layer', true);

        mapLayer.selectAll('path')
            .data(geo.features)
            .enter()
            .append('path')
            .attr('d', path)
            .attr('fill', mapColorStatic)
            .attr('opacity', .5)
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);

        var circles = mapLayer.selectAll("c")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", function (d) { return projection([d.lng, d.lat])[0]; })
            .attr("cy", function (d) { return projection([d.lng, d.lat])[1]; })
            .attr("r", function(d) { return d.value / 3; }) // todo: scale by all values
            .attr('opacity', .5)
            .style("fill", function(d) { return colorCircles(d.value); })
            .on("mouseover", handleMouseOver)
            .on("mouseout", handleMouseOut);
    }

    function handleMouseOver(d, i) {
        d3.select(this)
            .attr('opacity', 1.)
    }

    function handleMouseOut(d, i) {
        d3.select(this)
            .attr('opacity', .5)
    }

    function swapMaps(m, i, j) {
        [m[i], m[j]] = [m[j], m[i]];
    }

    // load map
    var geoAusStates = [];
    var mapData = [];
    var csvFileNames = ['A', 'B'];

    var q = d3.queue();

    q.defer(d3.json, "states.min.geojson");
    for (i = 0; i < csvFileNames.length; i++) {
        q.defer(d3.csv, csvFileNames[i] + ".csv", function(d) {
            return {    
                city: d.city,
                lat: +d.lat,
                lng: +d.lng,
                value: +d.value
            };

        });
    }
    q.awaitAll(function(e, files) {
        geoAusStates = files[0];
        for (var i = 1; i < files.length; i++)
            mapData.push(files[i]);

        renderMaps(geoAusStates, mapData)
    });
    
</script>
